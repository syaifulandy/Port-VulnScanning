#!/bin/bash
# perlu install xmlstarlet: sudo apt install xmlstarlet
# Input: file XML hasil Nmap
NMAP_XML="$1"

# Cek file ada atau tidak
if [[ ! -f "$NMAP_XML" ]]; then
    echo "File tidak ditemukan: $NMAP_XML"
    exit 1
fi

# Gunakan xmllint untuk parsing
xmllint --xpath '//host' "$NMAP_XML" 2>/dev/null | \
awk -v RS='<host' -F'\n' '
{
    ip = ""; ports = "";
    if ($0 ~ /addr=/) {
        match($0, /addr="([0-9.]+)"/, a);
        ip = a[1];
    }
    n = split($0, lines, "\n");
    for (i = 1; i <= n; i++) {
        if (lines[i] ~ /<port/ && lines[i+1] ~ /state state="open"/) {
            match(lines[i], /portid="([0-9]+)"/, p);
            if (ports == "")
                ports = p[1];
            else
                ports = ports "," p[1];
        }
    }
    if (ip != "" && ports != "")
        print ip ";" ports;
}
'
